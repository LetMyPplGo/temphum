<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Control Panel</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* ===== CSS Variables ===== */
    :root {
      --color-bg: #0b0f14;
      --color-panel: rgba(255, 255, 255, 0.06);
      --color-panel-strong: rgba(255, 255, 255, 0.12);
      --color-text: #e5ecf5;
      --color-text-muted: #9aa8be;
      --color-accent-primary: #70e1ff;
      --color-accent-secondary: #9b59ff;
      --color-success: #35d399;

      --border-radius-sm: 10px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;

      --spacing-xs: 6px;
      --spacing-sm: 10px;
      --spacing-md: 12px;
      --spacing-lg: 18px;
      --spacing-xl: 24px;

      --transition-fast: 0.15s ease;
      --transition-base: 0.2s ease;

      --z-dropdown: 1000;
      --z-toast: 2000;
    }

    /* ===== Reset & Base ===== */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      color: var(--color-text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(112, 225, 255, 0.08), transparent 60%),
        radial-gradient(1200px 600px at 110% 110%, rgba(155, 89, 255, 0.08), transparent 60%),
        var(--color-bg);
      font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===== Layout ===== */
    .container {
      max-width: 1080px;
      margin: 40px auto;
      padding: 0 20px 40px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      margin-top: var(--spacing-xl);
    }

    .tabs {
      margin-top: var(--spacing-lg);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .tabs__list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .tabs__list form {
      margin: 0;
    }

    .tab-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--color-panel-strong);
      background: rgba(255, 255, 255, 0.03);
      color: #d7e2f2;
      font-weight: 600;
      cursor: pointer;
      transition: border-color var(--transition-fast), transform var(--transition-fast);
    }

    .tab-btn:hover {
      border-color: #6aa4c9;
    }

    .tab-btn--active {
      background: rgba(106, 164, 201, 0.18);
      border-color: rgba(106, 164, 201, 0.55);
      color: #eef5ff;
    }

    .tab-actions {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      align-items: center;
      justify-content: flex-start;
      margin-bottom: var(--spacing-md);
    }

    .tab-actions form {
      margin: 0;
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .tab-actions--spacer {
      height: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    @media (max-width: 900px) {
      .grid > * {
        grid-column: span 12 !important;
      }
    }

    /* ===== Typography ===== */
    .page-title {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin: 0;
    }

    .page-title__gradient {
      color: transparent;
      background: linear-gradient(90deg, var(--color-accent-primary), var(--color-accent-secondary));
      background-clip: text;
      -webkit-background-clip: text;
      text-shadow: 0 0 24px rgba(112, 225, 255, 0.25);
    }

    .card__title {
      margin: 0 0 var(--spacing-md);
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .text-muted {
      color: var(--color-text-muted);
      font-size: 12px;
    }

    /* ===== Card Component ===== */
    .card {
      background: var(--color-panel);
      backdrop-filter: blur(10px);
      border: 1px solid var(--color-panel-strong);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    .card--wifi { grid-column: span 6; }
    .card--bus { grid-column: span 6; }
    .card--api { grid-column: span 6; }
    .card--display { grid-column: span 6; }
    .card--chart { grid-column: span 12; }
    .card--tab { grid-column: span 6; }

    /* ===== Form Elements ===== */
    .form-group {
      margin-bottom: var(--spacing-md);
    }

    .form-label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-size: 12px;
      color: var(--color-text-muted);
      font-weight: 500;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: var(--spacing-md) 14px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--color-panel-strong);
      border-radius: var(--border-radius-md);
      color: var(--color-text);
      font-size: 14px;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--color-accent-primary);
      box-shadow: 0 0 0 3px rgba(112, 225, 255, 0.18);
    }

    .form-input::placeholder {
      color: var(--color-text-muted);
      opacity: 0.6;
    }

    .form-textarea {
      font-family: 'DejaVu Sans Mono', 'Inconsolata', 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      line-height: 1.6;
      letter-spacing: 0;
      min-height: 140px;
      resize: vertical;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
    }

    /* ===== Button Component ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: var(--spacing-sm) 14px;
      background: linear-gradient(90deg, var(--color-accent-primary), var(--color-accent-secondary));
      border: none;
      border-radius: var(--border-radius-md);
      color: var(--color-bg);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.06s ease, filter var(--transition-base);
      white-space: nowrap;
    }

    .btn:hover {
      filter: brightness(1.05);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== Custom Select Component ===== */
    .custom-select {
      position: relative;
    }

    .custom-select__trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: var(--spacing-md) 14px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--color-panel-strong);
      border-radius: var(--border-radius-md);
      color: var(--color-text);
      font-size: 14px;
      cursor: pointer;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .custom-select__trigger:hover {
      border-color: var(--color-accent-primary);
    }

    .custom-select__trigger:focus {
      outline: none;
      border-color: var(--color-accent-primary);
      box-shadow: 0 0 0 3px rgba(112, 225, 255, 0.18);
    }

    .custom-select__trigger::after {
      content: '▼';
      font-size: 10px;
      color: var(--color-text-muted);
      transition: transform var(--transition-fast);
    }

    .custom-select--open .custom-select__trigger::after {
      transform: rotate(180deg);
    }

    /* ===== Dropdown Component ===== */
    .dropdown {
      position: fixed;
      background: rgba(8, 12, 18, 0.98);
      border: 1px solid var(--color-panel-strong);
      border-radius: var(--border-radius-md);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      max-height: 280px;
      overflow: hidden;
      display: none;
      z-index: var(--z-dropdown);
    }

    .dropdown--open {
      display: flex;
      flex-direction: column;
    }

    .dropdown__search {
      position: sticky;
      top: 0;
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-md);
      background: rgba(8, 12, 18, 0.98);
      color: var(--color-text);
      border: none;
      border-bottom: 1px solid var(--color-panel-strong);
      border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
      font-size: 14px;
      outline: none;
      z-index: 1;
    }

    .dropdown__search::placeholder {
      color: var(--color-text-muted);
      opacity: 0.6;
    }

    .dropdown__list {
      overflow-y: auto;
      max-height: 220px;
      background: rgba(8, 12, 18, 0.98);
    }

    .dropdown__option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      cursor: pointer;
      transition: background-color 0.1s ease;
    }

    .dropdown__option:hover {
      background: rgba(255, 255, 255, 0.06);
    }

    .dropdown__option--active {
      background: rgba(112, 225, 255, 0.15);
    }

    .dropdown__option[hidden] {
      display: none;
    }

    /* ===== Toast Notifications ===== */
    .toast-container {
      position: fixed;
      top: 18px;
      right: 18px;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      z-index: var(--z-toast);
    }

    .toast {
      padding: var(--spacing-sm) var(--spacing-md);
      background: rgba(53, 211, 153, 0.12);
      border: 1px solid rgba(53, 211, 153, 0.35);
      border-radius: var(--border-radius-sm);
      color: #b8f7dc;
      backdrop-filter: blur(6px);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* ===== Chart ===== */
    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 360px;
    }

    .chart-note {
      margin-top: var(--spacing-md);
      font-size: 12px;
      color: var(--color-text-muted);
    }

    /* ===== Display Panel ===== */
    .display-panel {
      font-family: 'DejaVu Sans Mono', 'Inconsolata', 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      line-height: 1.6;
      letter-spacing: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* ===== Utility Classes ===== */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Page Header -->
    <h1 class="page-title">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 3l3 3-3 3-3-3 3-3zm0 12l3 3-3 3-3-3 3-3zM3 12l3-3 3 3-3 3-3-3zm12 0l3-3 3 3-3 3-3-3z"
              stroke="url(#gradient)" stroke-width="1.2" />
        <defs>
          <linearGradient id="gradient" x1="0" y1="0" x2="24" y2="24">
            <stop stop-color="#70e1ff"/>
            <stop offset="1" stop-color="#9b59ff"/>
          </linearGradient>
        </defs>
      </svg>
      <span>The <span class="page-title__gradient">Bus Box</span></span>
    </h1>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="toast-container" id="toastContainer" role="status" aria-live="polite">
          {% for message in messages %}
            <div class="toast">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Tabs -->
    <div class="tabs">
      <div class="tabs__list" role="tablist" aria-label="Configuration tabs">
        {% for t in tabs %}
          <form method="post" action="{{ url_for('select_tab') }}">
            <input type="hidden" name="tab_id" value="{{ t.id }}">
            <button
              type="submit"
              class="tab-btn {% if t.id == active_tab_id %}tab-btn--active{% endif %}"
              role="tab"
              aria-selected="{% if t.id == active_tab_id %}true{% else %}false{% endif %}"
            >
              {{ t.name }}
            </button>
          </form>
        {% endfor %}
      </div>
    </div>

    <!-- Main Grid -->
    <div class="grid">
      {% if tab.id != 'settings' %}
        <!-- Tab Settings Card -->
        <section class="card card--tab">
          <h2 class="card__title">Tab settings</h2>
          <div class="tab-actions">
            <form method="post" action="{{ url_for('save_tab_name') }}">
              <input type="hidden" name="tab_id" value="{{ tab.id }}">
              <input
                type="text"
                id="tabName"
                name="tab_name"
                class="form-input"
                placeholder="e.g. Home, Office"
                value="{{ tab.name or '' }}"
                autocomplete="off"
                required
              >
              <button type="submit" class="btn">Save</button>
            </form>
          </div>
          <div class="tab-actions">
            <form method="post" action="{{ url_for('save_tab_mode') }}">
              <input type="hidden" name="tab_id" value="{{ tab.id }}">
              <select name="tab_mode" class="form-select" aria-label="Tab mode">
                <option value="bus" {% if tab.mode == 'bus' %}selected{% endif %}>Bus</option>
                <option value="train" {% if tab.mode == 'train' %}selected{% endif %}>Train</option>
              </select>
              <button type="submit" class="btn">Apply</button>
            </form>
          </div>
          <div class="tab-actions">
            <form method="post" action="{{ url_for('remove_tab') }}">
              <input type="hidden" name="tab_id" value="{{ tab.id }}">
              <button type="submit" class="btn">Remove tab</button>
            </form>
          </div>
          <div class="tab-actions tab-actions--spacer"></div>
          <div class="tab-actions">
            <form method="post" action="{{ url_for('add_tab') }}">
              <input
                type="text"
                name="tab_name"
                class="form-input"
                placeholder="New tab name"
                autocomplete="off"
              >
              <button type="submit" class="btn">Add tab</button>
            </form>
          </div>
        </section>
      {% endif %}
      {% if tab.id == 'settings' %}
        <!-- WiFi Settings Card -->
        <section class="card card--wifi">
          <h2 class="card__title">Wi-Fi settigns</h2>
          <form method="post" action="{{ url_for('save_wifi') }}">
            <div class="form-group">
              <label for="ssid" class="form-label">Network name (SSID)</label>
              <input
                type="text"
                id="ssid"
                name="ssid"
                class="form-input"
                placeholder="MyWiFi"
                value="{{ wifi_ssid or '' }}"
                autocomplete="off"
                required
              >
            </div>

            <div class="form-group">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                id="password"
                name="password"
                class="form-input"
                placeholder="••••••••"
                value="{{ wifi_password or '' }}"
                autocomplete="new-password"
                required
              >
            </div>

            <div class="form-actions">
              <button type="submit" class="btn">Save</button>
            </div>
          </form>
        </section>

        <!-- API Key Card -->
        <section class="card card--api">
          <h2 class="card__title">API Key for https://reading-opendata.r2p.com</h2>
          <form method="post" action="{{ url_for('save_api_key') }}">
            <div class="form-group">
              <label for="apiKey" class="form-label">API Key</label>
              <input
                type="text"
                id="apiKey"
                name="api_key"
                class="form-input"
                placeholder="r2p_xxx_yyy"
                value="{{ api_key or '' }}"
                autocomplete="off"
                spellcheck="false"
              >
            </div>

            <div class="form-actions">
              <button type="submit" class="btn">Save</button>
            </div>
          </form>
        </section>
      {% endif %}

      {% if tab.id != 'settings' %}
        <!-- Bus Stop Selection Card -->
        <section class="card card--bus" {% if tab.mode != 'bus' %}style="display:none"{% endif %}>
          <h2 class="card__title">Bus stop</h2>
          <form method="post" action="{{ url_for('save_stop') }}">
            <input type="hidden" name="tab_id" value="{{ tab.id }}">
            <div class="form-group">
              <label for="busStopSelect" class="form-label">Pick your stop</label>

              <div class="custom-select" id="busStopSelect" data-selected="{{ stop_id or '' }}">
                <div
                  class="custom-select__trigger"
                  role="button"
                  tabindex="0"
                  aria-haspopup="listbox"
                  aria-expanded="false"
                  id="busStopTrigger"
                >
                  <span id="busStopDisplay">— pick you stop —</span>
                </div>
                <input type="hidden" name="stop_id" id="busStopValue" value="{{ stop_id or '' }}">
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn">Save</button>
            </div>
          </form>

          <iframe
                  style="border:0"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  src="https://www.google.com/maps?q={{coordinates}}&z=15&output=embed">
          </iframe>
        </section>

        <!-- Train Selection Card -->
        <section class="card card--bus" {% if tab.mode != 'train' %}style="display:none"{% endif %}>
          <h2 class="card__title">Train stops</h2>
          <form method="post" action="{{ url_for('save_train_stop') }}">
            <input type="hidden" name="tab_id" value="{{ tab.id }}">
            <div class="form-group">

              <label for="trainFromSelect" class="form-label">Pick departure stop</label>
              <div class="custom-select" id="trainFromSelect" data-selected="{{ train_from or '' }}">
                <div
                  class="custom-select__trigger"
                  role="button"
                  tabindex="0"
                  aria-haspopup="listbox"
                  aria-expanded="false"
                  id="trainFromTrigger"
                >
                  <span id="trainFromDisplay">— pick you stop —</span>
                </div>
                <input type="hidden" name="train_from" id="trainFromValue" value="{{ train_from or '' }}">
              </div>

              <label for="trainToSelect" class="form-label">Pick destination stop</label>
              <div class="custom-select" id="trainToSelect" data-selected="{{ train_to or '' }}">
                <div
                  class="custom-select__trigger"
                  role="button"
                  tabindex="0"
                  aria-haspopup="listbox"
                  aria-expanded="false"
                  id="trainToTrigger"
                >
                  <span id="trainToDisplay">— pick you stop —</span>
                </div>
                <input type="hidden" name="train_to" id="trainToValue" value="{{ train_to or '' }}">
              </div>

            </div>

            <div class="form-actions">
              <button type="submit" class="btn">Save</button>
            </div>
          </form>

          <!--iframe
                  style="border:0"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  src="https://www.google.com/maps?q={{train_coordinates}}&z=15&output=embed">
          </iframe-->
            <!--src="https://www.google.com/maps/embed/v1/directions?key={{google_api_key}}&origin={{coordinates_from}}&destination={{coordinates_to}}&mode=transit"-->
          <iframe
            src="https://www.google.com/maps/embed/v1/directions?key={{google_api_key}}&origin={{coordinates_from}}&destination={{coordinates_to}}&mode=transit"
            width="400"
            height="200">
          </iframe>
        </section>

        <!-- Display Panel Card -->
        <section class="card card--display">
          <h2 class="card__title">Display</h2>
          <pre class="display-panel">{% if pixel_lines %}{{ "\n".join(pixel_lines) }}{% endif %}</pre>
        </section>
      {% endif %}


      <!-- Chart Card ->
      <section class="card card--chart">
        <h2 class="card__title">График</h2>
        <div class="chart-wrapper">
          <canvas id="chartCanvas"></canvas>
        </div>
        <p class="chart-note">
          Optional Temperature and Humidity chart goes here.
        </p>
      </section>
      <!- -->
    </div>
  </div>

  <!-- Bus stop. Dropdown Portal (rendered outside main structure) -->
  <div
    class="dropdown"
    id="busStopDropdown"
    role="listbox"
    aria-label="Pick your bus stop"
  >
    <input
      type="search"
      class="dropdown__search"
      id="busStopSearch"
      placeholder="Search…"
      aria-label="Bus stop search"
    >
    <div class="dropdown__list" id="busStopList">
      {% for stop in bus_stops %}
        <div
          class="dropdown__option"
          role="option"
          data-id="{{ stop.id }}"
          data-name="{{ stop.name }}"
        >
          <span>{{ stop.name }}</span>
          <span class="text-muted">#{{ stop.id }}</span>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Train From. Dropdown Portal (rendered outside main structure) -->
  <div
    class="dropdown"
    id="trainFromDropdown"
    role="listbox"
    aria-label="Pick train departure stop"
  >
    <input
      type="search"
      class="dropdown__search"
      id="trainFromSearch"
      placeholder="Search…"
      aria-label="Train stop search"
    >
    <div class="dropdown__list" id="trainFromList">
      {% for stop in train_stops %}
        <div
          class="dropdown__option"
          role="option"
          data-id="{{ stop.crs }}"
          data-name="{{ stop.name }}"
        >
          <span>{{ stop.name }}</span>
          <span class="text-muted">#{{ stop.crs }}</span>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Train To. Dropdown Portal (rendered outside main structure) -->
  <div
    class="dropdown"
    id="trainToDropdown"
    role="listbox"
    aria-label="Pick train destination stop"
  >
    <input
      type="search"
      class="dropdown__search"
      id="trainToSearch"
      placeholder="Search…"
      aria-label="Train stop search"
    >
    <div class="dropdown__list" id="trainToList">
      {% for stop in train_stops %}
        <div
          class="dropdown__option"
          role="option"
          data-id="{{ stop.crs }}"
          data-name="{{ stop.name }}"
        >
          <span>{{ stop.name }}</span>
          <span class="text-muted">#{{ stop.crs }}</span>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    'use strict';

    // ===== Toast Manager =====
    (function initToasts() {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      setTimeout(() => {
        container.style.opacity = '0';
        container.style.transition = 'opacity 0.3s ease';
        setTimeout(() => container.remove(), 300);
      }, 3200);
    })();

    // ===== Chart Initialization =====
    (function initChart() {
      const canvas = document.getElementById('chartCanvas');
      if (!canvas || !window.Chart) return;

      const now = Date.now();
      const labels = Array.from({ length: 12 }, (_, i) => {
        const date = new Date(now - (11 - i) * 3600000);
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      });
      const data = Array.from({ length: 12 }, () => Math.round(30 + Math.random() * 10));

      new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Demo',
            data,
            borderColor: '#70e1ff',
            backgroundColor: 'rgba(112, 225, 255, 0.1)',
            tension: 0.4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#cfe7ff' }
            }
          },
          scales: {
            x: {
              ticks: { color: '#9aa8be' },
              grid: { color: 'rgba(154, 168, 190, 0.15)' }
            },
            y: {
              ticks: { color: '#9aa8be' },
              grid: { color: 'rgba(154, 168, 190, 0.15)' }
            }
          }
        }
      });
    })();

    // ===== Custom Select with Dropdown =====
    function initSelect(prefix) {
      const selectContainer = document.getElementById(prefix + 'Select');
      if (!selectContainer) return;

      const trigger = document.getElementById(prefix + 'Trigger');
      const display = document.getElementById(prefix + 'Display');
      const hiddenInput = document.getElementById(prefix + 'Value');
      const dropdown = document.getElementById(prefix + 'Dropdown');
      const searchInput = document.getElementById(prefix + 'Search');
      const optionsList = document.getElementById(prefix + 'List');
      const options = Array.from(optionsList.querySelectorAll('.dropdown__option'));

      let isOpen = false;

      // Initialize selected value
      const initialId = selectContainer.dataset.selected;
      if (initialId) {
        const initialOption = options.find(opt => opt.dataset.id === initialId);
        if (initialOption) {
          setActiveOption(initialOption);
        }
      }

      // Position dropdown
      function positionDropdown() {
        const rect = trigger.getBoundingClientRect();
        dropdown.style.left = `${rect.left}px`;
        dropdown.style.top = `${rect.bottom + 6}px`;
        dropdown.style.width = `${rect.width}px`;
      }

      // Open dropdown
      function open() {
        if (isOpen) return;
        positionDropdown();
        dropdown.classList.add('dropdown--open');
        selectContainer.classList.add('custom-select--open');
        trigger.setAttribute('aria-expanded', 'true');
        isOpen = true;
        searchInput.focus();
      }

      // Close dropdown
      function close() {
        if (!isOpen) return;
        dropdown.classList.remove('dropdown--open');
        selectContainer.classList.remove('custom-select--open');
        trigger.setAttribute('aria-expanded', 'false');
        searchInput.value = '';
        filterOptions();
        isOpen = false;
      }

      // Set active option
      function setActiveOption(option) {
        options.forEach(opt => opt.classList.remove('dropdown__option--active'));
        option.classList.add('dropdown__option--active');
        display.textContent = `${option.dataset.name}  (#${option.dataset.id})`;
        hiddenInput.value = option.dataset.id;
      }

      // Filter options
      function filterOptions() {
        const query = searchInput.value.trim().toLowerCase();
        options.forEach(option => {
          const text = `${option.dataset.name} ${option.dataset.id}`.toLowerCase();
          const matches = text.includes(query);
          option.hidden = !matches;
        });
      }

      // Event: Trigger click
      trigger.addEventListener('click', () => {
        isOpen ? close() : open();
      });

      // Event: Trigger keyboard
      trigger.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          isOpen ? close() : open();
        }
      });

      // Event: Search input
      searchInput.addEventListener('input', filterOptions);

      // Event: Option click
      options.forEach(option => {
        option.addEventListener('click', () => {
          setActiveOption(option);
          close();
        });
      });

      // Event: Click outside
      document.addEventListener('click', (e) => {
        if (!selectContainer.contains(e.target) && !dropdown.contains(e.target)) {
          close();
        }
      });

      // Event: Window scroll/resize
      window.addEventListener('scroll', close, { passive: true });
      window.addEventListener('resize', close);

      // Event: Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!isOpen) return;

        const visibleOptions = options.filter(opt => !opt.hidden);
        const currentIndex = visibleOptions.findIndex(opt =>
          opt.classList.contains('dropdown__option--active')
        );

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            const nextIndex = currentIndex < 0 ? 0 : Math.min(currentIndex + 1, visibleOptions.length - 1);
            setActiveOption(visibleOptions[nextIndex]);
            visibleOptions[nextIndex].scrollIntoView({ block: 'nearest' });
            break;

          case 'ArrowUp':
            e.preventDefault();
            const prevIndex = currentIndex <= 0 ? 0 : currentIndex - 1;
            setActiveOption(visibleOptions[prevIndex]);
            visibleOptions[prevIndex].scrollIntoView({ block: 'nearest' });
            break;

          case 'Enter':
            e.preventDefault();
            close();
            break;

          case 'Escape':
            e.preventDefault();
            close();
            trigger.focus();
            break;
        }
      });
    };

    initSelect('busStop');
    initSelect('trainFrom');
    initSelect('trainTo');
  </script>
</body>
</html>
